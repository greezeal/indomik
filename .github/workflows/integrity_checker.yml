name: Chapter Integrity Checker

on:
  schedule:
    - cron: "*/10 * * * *" # Menjalankan setiap 10 meni
  workflow_dispatch: # Memungkinkan menjalankan manual dari tab Actions

jobs:
  check:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r scraper/requirements.txt

      - name: Run Integrity Checker (Single Comic Rotation)
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          STATE_FILE="data/.integrity_state.json"

          # Get sorted list of all comics
          COMICS=($(ls -1 data/comics/ | sort))
          TOTAL_COMICS=${#COMICS[@]}

          echo "Total comics: $TOTAL_COMICS"

          # Read current index from state file
          if [ -f "$STATE_FILE" ]; then
            CURRENT_INDEX=$(cat "$STATE_FILE" | python3 -c "import sys, json; print(json.load(sys.stdin).get('current_index', 0))")
          else
            CURRENT_INDEX=0
          fi

          # Wrap around if index exceeds total
          if [ $CURRENT_INDEX -ge $TOTAL_COMICS ]; then
            CURRENT_INDEX=0
          fi

          # Get current comic to check
          COMIC=${COMICS[$CURRENT_INDEX]}
          NEXT_INDEX=$((CURRENT_INDEX + 1))

          echo "=========================================="
          echo "Checking comic #$((CURRENT_INDEX + 1)) of $TOTAL_COMICS"
          echo "Comic: $COMIC"
          echo "=========================================="

          # Run integrity checker for this comic only
          python -u scraper/integrity_checker.py --comic "$COMIC" --delay 2

          # Update state file with next index
          echo "{\"current_index\": $NEXT_INDEX, \"last_checked\": \"$COMIC\", \"checked_at\": \"$(date -u +'%Y-%m-%dT%H:%M:%SZ')\"}" > "$STATE_FILE"

          # Commit changes (both data and state)
          git add data/

          if ! git diff-index --quiet HEAD; then
            CHANGES_DETECTED=$(git diff --cached --name-only | grep -v ".integrity_state.json" | wc -l)
            
            if [ $CHANGES_DETECTED -gt 0 ]; then
              git commit -m "fix: integrity update for $COMIC [$((CURRENT_INDEX + 1))/$TOTAL_COMICS]"
            else
              git commit -m "chore: integrity check $COMIC [$((CURRENT_INDEX + 1))/$TOTAL_COMICS] - no changes"
            fi
            
            git push
            echo "[âœ“] Progress saved"
          else
            echo "[=] No changes to commit"
          fi

          echo ""
          echo "=========================================="
          echo "Next run will check: ${COMICS[$NEXT_INDEX]:-${COMICS[0]}} (#$((NEXT_INDEX % TOTAL_COMICS + 1)))"
          echo "Estimated full cycle: $((TOTAL_COMICS * 10)) minutes (~$((TOTAL_COMICS * 10 / 60)) hours)"
          echo "=========================================="
