name: Chapter Integrity Checker

on:
  schedule:
    - cron: "0 */3 * * *" # Menjalankan setiap 3 jam sekali
  workflow_dispatch: # Memungkinkan menjalankan manual dari tab Actions

jobs:
  check:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r scraper/requirements.txt

      - name: Run Integrity Checker (One Comic at a Time with Commits)
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Get list of all comics
          COMICS=$(ls -1 data/comics/)

          for COMIC in $COMICS; do
            echo "=========================================="
            echo "Checking: $COMIC"
            echo "=========================================="
            
            # Run integrity checker for this comic only
            python -u scraper/integrity_checker.py --comic "$COMIC" --delay 2
            
            # Check if there are changes and commit immediately
            if ! git diff-index --quiet HEAD -- "data/comics/$COMIC/"; then
              git add "data/comics/$COMIC/"
              git commit -m "fix: integrity update for $COMIC [$(date +'%Y-%m-%d %H:%M')]"
              git push
              echo "[âœ“] Changes committed for $COMIC"
            else
              echo "[=] No changes for $COMIC"
            fi
            
            echo ""
          done

          echo "=========================================="
          echo "All comics checked!"
          echo "=========================================="
